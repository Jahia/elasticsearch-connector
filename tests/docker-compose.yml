version: '3.6'
services:
  jahia:
    image: '${JAHIA_IMAGE}'
    container_name: jahia
    hostname: jahia
    restart: 'no'
    deploy:
      resources:
        limits:
          memory: 4gb
    ports:
      - "8080:8080"
      - "8101:8101"
      - "8000:8000"
    extra_hosts:
      - jahia:127.0.0.1
    environment:
      jahia_cfg_karaf_remoteShellHost: 0.0.0.0
      JAHIA_LICENSE: ${JAHIA_LICENSE}
      SUPER_USER_PASSWORD: ${SUPER_USER_PASSWORD}
      PROCESSING_SERVER: 'true'
      MAX_RAM_PERCENTAGE: 95
      JAHIA_PROPERTIES: ${JAHIA_PROPERTIES}
      CATALINA_OPTS: ${CATALINA_OPTS}
      RESTORE_MODULE_STATES: 'false'
      NEXUS_USERNAME: ${NEXUS_USERNAME}
      NEXUS_PASSWORD: ${NEXUS_PASSWORD}
      ELASTIC_PWD_ENCODED: ${ELASTIC_PWD_ENCODED}
      TZ: ${TIMEZONE}
      JPDA: 'true'
    networks:
      - stack

  elasticsearch:
    image: '${ELASTICSEARCH_IMAGE}'
    container_name: elasticsearch
    environment:
      - node.name=es01
      - cluster.name=cluster01
      - discovery.type=single-node
      - xpack.security.enabled=true
      - ELASTIC_PASSWORD=${SUPER_USER_PASSWORD}
      # workaround fix for Apple Silicon (M1/M2)
      # - _JAVA_OPTIONS=-XX:UseSVE=0
      # Remove 'not all primary shards of [.geoip_databases] index are active' error
      - ingest.geoip.downloader.enabled=false
      - TZ=${TIMEZONE}
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
    deploy:
      resources:
        limits:
          memory: 4G
    ports:
        - 9200:9200
    ulimits:
        memlock:
          soft: -1
          hard: -1
    networks:
      - stack

  cypress:
    image: '${TESTS_IMAGE}'
    container_name: cypress
    depends_on:
      - jahia
    environment:
      JAHIA_LICENSE: ${JAHIA_LICENSE}
      MANIFEST: ${MANIFEST}
      JAHIA_USERNAME: ${JAHIA_USERNAME}
      JAHIA_PASSWORD: ${JAHIA_PASSWORD}
      JAHIA_URL: ${JAHIA_URL}
      JAHIA_HOST: ${JAHIA_HOST}
      JAHIA_PORT: ${JAHIA_PORT}
      NEXUS_USERNAME: ${NEXUS_USERNAME}
      NEXUS_PASSWORD: ${NEXUS_PASSWORD}
      SUPER_USER_PASSWORD: ${SUPER_USER_PASSWORD}
    networks:
      - stack

networks:
  stack:
